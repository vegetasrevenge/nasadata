<!DOCTYPE html>
<html>
<head>

    <style>
        body {
            display: flex;
            flex-flow: column;
            align-items: center;
        }
        #map {
            flex-basis: 50%;
            width: 50%;
            height: 400px;
            border-radius: 50px;
            border: inset rgba(0, 0, 0, 1);
        }
        form {
            padding: 20px;
        }
    </style>
</head>
<body>

    <nav>
        <a href="/login"><h2>Login</h2></a>
        <a href="/register"><h2>Register</h2></a>
    </nav>

    <h3>Meteorite Map Tool</h3>
    <div id="map"></div>

    <form action="/api/meteorites" method="GET">
        <fieldset>
            <legend>Search Meteorites By Year</legend>
            <input id="min" type="text" name="min" min="860" placeholder="Start Year"/>
            <input id="max" type="text" name="max" max="2015" placeholder="End Year"/>
            <button id="button" type="submit">Search</button>
        </fieldset>
    </form>
    <div th:if="${#authentication}">
        <form action="/add_meteorite" method="POST">
            <fieldset>
                <legend>Record Your Meteorite</legend>
                <input type="text" name="name" placeholder="Name"/>
                <input type="text" name="nameType" placeholder="Name Type"/>
                <input type="text" name="recClass" placeholder="Class"/>
                <input type="number" name="mass" placeholder="Mass(g)"/>
                <input type="text" name="fall" placeholder="Observed Fall or Found"/>
                <input type="number" name="year" placeholder="Year Discovered"/>
                <input type="text" name="recLat" placeholder="Latitude"/>
                <input type="text" name="recLong" placeholder="Longitude"/>
                <button type="submit">Submit</button>
            </fieldset>
        </form>
    </div>

    <div>
        <h2 th:text="${message}"></h2>
    </div>


    <script th:inline="javascript">

        /*<![CDATA[*/

        let map;
        let markers;
        let bounds;

        function initMap() {

            var origin = {lat: 32.897480, lng: -97.040443};
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: origin
            });
            var marker = new google.maps.Marker({
                position: origin,
                map: map,
                visible: false
            });
        }

        const button = document.querySelector("#button");
        const min = document.querySelector("#min");
        const max = document.querySelector("#max");

        button.addEventListener("click", fetchFunction);
        function fetchFunction(evt) {
            evt.preventDefault();

            fetch(`/api/meteorites?min=${min.value}&max=${max.value}`)
                .then(function (response) {
                    return response.json();
                }).then(plotMarkers);
        }


        function plotMarkers(m) {

            if(markers) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
            }

            markers = [];
            bounds = new google.maps.LatLngBounds();
            console.log(map);
            m.forEach(function (marker) {
                //create text windows for marker
                var position = new google.maps.LatLng(marker.recLat, marker.recLong);
    //            var image = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQhx_YT41IWa9ggF3ebidlsIvUnLNGvmz3GQf0Ml307bGQO0_OMZA';
                console.log(marker);
                markers.push(
                    new google.maps.Marker({
                        position: position,
                        map: map,
                        animation: google.maps.Animation.DROP,
                    })
                );
                bounds.extend(position);
            })
    //        map.fitBounds(bounds);
        }

        /*]]>*/
    </script>
    <script async="" defer=""
            th:src="@{https://maps.googleapis.com/maps/api/js?key=AIzaSyA1Xti-diTU1I36rLXgCAw6Mb-L-Yv7dNo&amp;callback=initMap}">
    </script>
</body>
</html>
